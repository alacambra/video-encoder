<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Encoder</title>
</head>
<body>

<div class="container">
  <div class="left-column">
    <label for="sourceName">File source name</label>
    <input type="text" id="sourceName" value="">

    <label for="targetName">File source name</label>
    <input type="text" id="targetName" value="">
    <button onclick="startEncoding()">TEST!!</button>
    <button onClick="uploadFileHandler(event)">select a video</button>
    <script type="text/javascript">

        function uploadFileStream(bytes, fileName) {
            postStream("encode/up", bytes);
        }

        function createDynamicInputFileElement() {

            const el = document.createElement("INPUT");

            el.type = "file";
            el.accept = "*/*";
            el.multiple = "multiple"; // remove to have a single file selection

            return el;
        }

        function uploadFileHandler(e1) {
            const el = createDynamicInputFileElement();

            el.addEventListener('change', function (e2) {

                if (!el.files.length) {
                    return;
                }

                const file = el.files[0];
                const reader = new FileReader();
                const fileName = file.name;
                reader.onload = function (event) {
                    uploadFileStream(event.target.result, fileName);
                };

                reader.readAsDataURL(file);
            });

            el.click();
        }

        async function startEncoding() {

            const source = document.getElementById("sourceName").value;
            const target = document.getElementById("targetName").value;

            await postData('encode', {
                source: source, target: target
            });
        }

        function postData(url = ``, data = {}) {
            return fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data),
            })
                .then(response => inspectResponse(response))
                .then(response => response.json());
        }

        function postStream(url = ``, data = {}) {
            return fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/octet-stream"
                },
                body: data,
            })
                .then(response => inspectResponse(response))
                .then(response => response.json());
        }

        function del(url) {
            return fetch(url, {
                method: "DELETE",
            }).then(response => inspectResponse(response))
        }

        function getData(url = ``, data = {}) {
            return fetch(url, {
                method: "GET"
            })
                .then(response => inspectResponse(response))
                .then(response => response.json());
        }

        function inspectResponse(response) {
            console.info(response.status, response.headers);
            return response;
        }

        window.onload = function () {

        };

    </script>
  </div>
</div>
</body>
</html>